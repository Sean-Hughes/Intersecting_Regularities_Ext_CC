---
title: "Study 1: Data Analysis"
author: "Sean Hughes"
date: "30-5-2020"
output: 
  html_document:
    code_folding: hide
    highlight: haddock
    theme: flatly
    toc: yes 
    toc_float: yes
---

```{r include=FALSE}
knitr::opts_chunk$set(message=FALSE,
                      warning=FALSE)
```


# Load the necessary packages

```{r}
library(foreign)
library(tidyverse)
library(Hmisc)
library(car)
library(readxl)
library(ggplot2)
library(dplyr)
library(xlsx)
library(ggthemes)
```

## 1. Import the raw data files from Excel into R

```{r}

wd <- list()
wd$data   <- "C:/Users/Sean/Desktop/Study_1/Raw_Data/"
wd$output <- "C:/Users/Sean/Desktop/Study_1/Processed_Data/"

data_belief_cover_story    <- read_xlsx(paste0(wd$data, "cover_belief_17_03_17.xlsx"), col_names = TRUE)
data_confidence_ratings    <- read_xlsx(paste0(wd$data, "confidence_ratings_17_03_17.xlsx"), col_names = TRUE)   
data_demand                <- read_xlsx(paste0(wd$data, "demand_17_03_17.xlsx"), col_names = TRUE)
data_demographics          <- read_xlsx(paste0(wd$data, "demographics_17_03_17.xlsx"), col_names = TRUE)
data_exploratory_questions <- read_xlsx(paste0(wd$data,"exploratory_questions_17_03_17.xlsx"), col_names = TRUE)
data_intentions_1          <- read_xlsx(paste0(wd$data, "intention_ratings_1_3_17_03_17.xlsx"), col_names = TRUE)
data_intentions_2          <- read_xlsx(paste0(wd$data, "intention_ratings_2_4_17_03_17.xlsx"), col_names = TRUE)
data_reactance             <- read_xlsx(paste0(wd$data, "reactance_17_03_17.xlsx"), col_names = TRUE)
data_ratings               <- read_xlsx(paste0(wd$data, "valence_ratings_17_03_17.xlsx"), col_names = TRUE)
data_task_order_1          <- read_xlsx(paste0(wd$data, "stimulus_ratings_before_17_03_17.xlsx"), col_names = TRUE)   
data_task_order_2          <- read_xlsx(paste0(wd$data, "stimulus_ratings_after_17_03_17.xlsx"), col_names = TRUE)   
data_stimulus_identity     <- read_csv2(paste0(wd$output, "Study_1_Stimulus_Identity.csv"), col_names = TRUE)
data_training_condition    <- read_csv2(paste0(wd$output,"Study_1_Complete_Training_Testing_Data.csv"), col_names = TRUE)
data_iat                   <- read_csv2(paste0(wd$output,"Study_1_IAT_Scores.csv"), col_names = TRUE) 

```

## 2. Prepare Demographic Data File 

```{r}

# Extract Age and Gender information for each subject

demographics_age <- data_demographics %>% 
  select(subject, trialcode, response) %>% 
  filter(trialcode != "ProlificCode") %>% 
  tibble::rowid_to_column() %>%
  spread(trialcode, response) %>%
  filter(age != "NA")

demographics_gender <- data_demographics %>% 
  select(subject, trialcode, response) %>% 
  filter(trialcode != "ProlificCode") %>% 
  tibble::rowid_to_column() %>%
  spread(trialcode, response) %>%
  filter(gender != "NA")

# Combine the files together
demographics <- demographics_age %>%
  left_join(demographics_gender, by = "subject")

# Identify duplicate data from the same participants

demographics$subject[duplicated(demographics$subject)]

# Remove duplicate data from the same participants based on the subject column

demographics <- demographics[!duplicated(demographics$subject), ]

# Retain only the columns necessary for data analysis

demographics <- demographics %>% 
  select(subject, age.x, gender.y) %>% 
  rename(Age = age.x, Gender = gender.y) %>% 
  arrange(subject)

# Clean up the Gender column so that it reads Male, Female, No Gender Provided 

Cleaned_demographics <- demographics %>%
    mutate(Gender = case_when(
    str_detect(Gender, "f") ~ "F",
    str_detect(Gender, "female")  ~ "F",
    str_detect(Gender, "Female")  ~ "F",
    str_detect(Gender, "femAle")  ~ "F",
    str_detect(Gender, "m")  ~ "M",
    str_detect(Gender, "MALE")  ~ "M",
    str_detect(Gender, "Male")  ~ "M",
    str_detect(Gender, "FDSF")  ~ "No Gender Info Provided",
   !str_detect(Gender, "F|M")  ~ "No Gender Info Provided",
    TRUE ~ Gender
    )
  ) 

  Cleaned_demographics$Gender[is.na(Cleaned_demographics$Gender)] <- "No Gender Info Provided"
  
  rm(demographics_age, demographics_gender, demographics)

```

## 3. Prepare Demand File

```{r}

# Select out the variables of interest and create a new (recoded) column that classifes people as demand vs. non-demand compliant

Cleaned_demand <- data_demand %>% 
  select(subject, Demand_response) %>%
  arrange(subject) %>%
  mutate(Demand_recoded = case_when(Demand_response == "What I learned during the experiment" ~ "Not Demand Compliant",
                            Demand_response == "I don't know why I evaluated the items as I did" ~ "Not Demand Compliant",
                            Demand_response == "What I learned during the experiment" ~ "Not Demand Compliant",
                            Demand_response == "What I thought the experimenter wanted me to say" ~ "Demand Compliant",
                            Demand_response == "I based my ratings on some some factor that was not what I learned or what the experimenter wanted me to do" ~ "Not Demand Compliant")) 
  
# Identify duplicate data from the same participants

Cleaned_demand[duplicated(Cleaned_demand$subject), ]

# Remove duplicate data from the same participants based on the subject column

Cleaned_demand <- Cleaned_demand[!duplicated(Cleaned_demand$subject), ]


```

## 4. Prepare Reactance File

```{r}

# Select out the columns from the raw data file that are relevant to reactance

Cleaned_reactance <- data_reactance %>% 
  select(subject, react1_response, react2_response) %>% 
  rename(reactance_question_1 = react1_response, reactance_question_2 = react2_response) %>%
  arrange(subject)

# Identify duplicate data from the same participants

Cleaned_reactance[duplicated(Cleaned_reactance$subject), ]

# Remove duplicate data from the same participants based on the subject column

Cleaned_reactance <- Cleaned_reactance[!duplicated(Cleaned_reactance$subject), ]

```

## 5. Prepare the belief in cover story File

```{r}

# Select out the columns from the raw data file that are relevant to believability

Cleaned_believability <- data_belief_cover_story %>% 
  select(subject, belief1_response, belief2_response) %>% 
  rename(believability_question_1 = belief1_response, believability_question_2 = belief2_response) %>%
  arrange(subject)

# Identify duplicate data from the same participants

Cleaned_believability[duplicated(Cleaned_believability$subject), ]

# Remove duplicate data from the same participants based on the subject column

Cleaned_believability <- Cleaned_believability[!duplicated(Cleaned_believability$subject), ]

```


## 6. Prepare confidence Files

```{r}

Cleaned_confidence <- data_confidence_ratings %>% 
  select(subject, Stimulus_1_Confidence_Confidence_response, Stimulus_2_Confidence_Confidence_response, Stimulus_3_Confidence_Confidence_response, Stimulus_4_Confidence_Confidence_response) %>% 
  rename(stim_1_confidence = Stimulus_1_Confidence_Confidence_response, stim_2_confidence = Stimulus_2_Confidence_Confidence_response, stim_3_confidence = Stimulus_3_Confidence_Confidence_response, stim_4_confidence = Stimulus_4_Confidence_Confidence_response) %>% 
  arrange(subject)

# Identify duplicate data from the same participants

Cleaned_confidence[duplicated(Cleaned_confidence$subject), ]

# Remove duplicate data from the same participants based on the subject column

Cleaned_confidence <- Cleaned_confidence[!duplicated(Cleaned_confidence$subject), ]

```

## 7. Prepare Ratings file

```{r}

Cleaned_ratings <- data_ratings %>% 
  select(subject, Stimulus_1_Positive_Negative_Positive_Negative_response, 
                  Stimulus_1_Good_Bad_Good_Bad_response, 
                  Stimulus_1_Pleasant_Unpleasant_Pleasant_Unpleasant_response, 
                  Stimulus_1_Like_Dislike_Like_Dislike_response, 
                  Stimulus_2_Positive_Negative_Positive_Negative_response, 
                  Stimulus_2_Good_Bad_Good_Bad_response, 
                  Stimulus_2_Pleasant_Unpleasant_Pleasant_Unpleasant_response,
                  Stimulus_2_Like_Dislike_Like_Dislike_response, 
                  Stimulus_3_Positive_Negative_Positive_Negative_response, 
                  Stimulus_3_Good_Bad_Good_Bad_response, 
                  Stimulus_3_Pleasant_Unpleasant_Pleasant_Unpleasant_response, 
                  Stimulus_3_Like_Dislike_Like_Dislike_response, 
                  Stimulus_4_Positive_Negative_Positive_Negative_response, 
                  Stimulus_4_Good_Bad_Good_Bad_response, 
                  Stimulus_4_Pleasant_Unpleasant_Pleasant_Unpleasant_response, 
                  Stimulus_4_Like_Dislike_Like_Dislike_response) %>% 
  arrange(subject) %>%
  rename(Outcome_1_Pos_Neg = Stimulus_1_Positive_Negative_Positive_Negative_response,
         Outcome_1_Good_Bad = Stimulus_1_Good_Bad_Good_Bad_response,
         Outcome_1_Pleasant_Unpleasant = Stimulus_1_Pleasant_Unpleasant_Pleasant_Unpleasant_response,
         Outcome_1_Like_Dislike = Stimulus_1_Like_Dislike_Like_Dislike_response,
         Outcome_2_Pos_Neg = Stimulus_3_Positive_Negative_Positive_Negative_response,
         Outcome_2_Good_Bad = Stimulus_3_Good_Bad_Good_Bad_response, 
         Outcome_2_Pleasant_Unpleasant = Stimulus_3_Pleasant_Unpleasant_Pleasant_Unpleasant_response,
         Outcome_2_Like_Dislike = Stimulus_3_Like_Dislike_Like_Dislike_response,
         Target_1_Pos_Neg = Stimulus_2_Positive_Negative_Positive_Negative_response,
         Target_1_Good_Bad = Stimulus_2_Good_Bad_Good_Bad_response, 
         Target_1_Pleasant_Unpleasant = Stimulus_2_Pleasant_Unpleasant_Pleasant_Unpleasant_response,
         Target_1_Like_Dislike = Stimulus_2_Like_Dislike_Like_Dislike_response,
         Target_2_Pos_Neg = Stimulus_4_Positive_Negative_Positive_Negative_response,
         Target_2_Good_Bad = Stimulus_4_Good_Bad_Good_Bad_response,
         Target_2_Pleasant_Unpleasant = Stimulus_4_Pleasant_Unpleasant_Pleasant_Unpleasant_response,
         Target_2_Like_Dislike = Stimulus_4_Like_Dislike_Like_Dislike_response) %>% 

  # Create a mean rating score for each stimulus
# Create an operant evaluative conditioning (OEC) and intersecting regularites (IR) effect
  mutate(Mean_Outcome_1 = (Outcome_1_Pos_Neg + Outcome_1_Good_Bad + Outcome_1_Pleasant_Unpleasant + Outcome_1_Like_Dislike)/4,
         Mean_Outcome_2 = (Outcome_2_Pos_Neg + Outcome_2_Good_Bad + Outcome_2_Pleasant_Unpleasant + Outcome_2_Like_Dislike)/4,
         Mean_Target_1 = (Target_1_Pos_Neg + Target_1_Good_Bad + Target_1_Pleasant_Unpleasant + Target_1_Like_Dislike)/4,
         Mean_Target_2 = (Target_2_Pos_Neg + Target_2_Good_Bad + Target_2_Pleasant_Unpleasant + Target_2_Like_Dislike)/4,
         OEC_Effect = Mean_Outcome_1 - Mean_Outcome_2,
         IR_Effect = Mean_Target_1 - Mean_Target_2)
  
# Identify duplicate data from the same participants

Cleaned_ratings[duplicated(Cleaned_ratings$subject), ]

# Remove duplicate data from the same participants based on the subject column

Cleaned_ratings <- Cleaned_ratings[!duplicated(Cleaned_ratings$subject), ]

# The identity of the outcome and target stimuli (Morag and Straun/ Chinese symbols) that intersected with positive or negative outcome stimuli were counterbalanced across participants. In order to address this counterbalancing factor we need to reverse score half of the scores. 

Cleaned_ratings <- data_stimulus_identity %>% 

  # Add stimulus identity information to the ratings
  
  full_join(Cleaned_ratings, by = "subject") %>%
# Remove individuals with incomplete data 
  
  drop_na() %>% 

# Reverse the scores for those who were in the Outcome_1_Target_1_Bad_Outcome_2_Target_2_Good group
   mutate(Transformed_OEC_Effect = ifelse(stimulus_identity == "Outcome_1_Target_1_Good_Outcome_2_Target_2_Bad", OEC_Effect, OEC_Effect * -1), 
           Transformed_IR_Effect = ifelse(stimulus_identity == "Outcome_1_Target_1_Good_Outcome_2_Target_2_Bad", IR_Effect, IR_Effect * -1))  
   

```

## 8. Prepare intention files for analysis

```{r}

data_intentions_1 <- data_intentions_1 %>% 
  select(subject, Intentions_1_3_response) %>%
  arrange(subject)

data_intentions_2 <- data_intentions_2 %>% 
   select(subject, Intentions_2_4_response) %>%
  arrange(subject)

Cleaned_intentions <- data_intentions_1 %>% 
  full_join(data_intentions_2, by = "subject")

# Identify duplicate data from the same participants

Cleaned_intentions[duplicated(Cleaned_intentions$subject), ]

# Remove duplicate data from the same participants based on the subject column

Cleaned_intentions <- Cleaned_intentions[!duplicated(Cleaned_intentions$subject), ]


```

## 9. Prepare Method Factors (Task Order, Training Performance, and Experimental Condition) for Analysis

```{r}

data_task_order_1 <- data_task_order_1 %>% 
  select(subject) %>% 
  arrange(subject) %>% 
  mutate(task_order = "Explicits First")

data_task_order_2 <- data_task_order_2 %>% 
  select(subject) %>% 
  arrange(subject) %>% 
  mutate(task_order = "Implicits First")

Cleaned_task_order <-  bind_rows(data_task_order_1, data_task_order_2) %>% 
  arrange(subject)

Cleaned_performance_condition <- data_training_condition %>%
  select(subject, training_performance, experimental_condition)

Cleaned_method_factors <- Cleaned_task_order %>%
  full_join(Cleaned_performance_condition, by = "subject")

rm(Cleaned_task_order, Cleaned_performance_condition)
```

## 10. Prepare the IAT Files

```{r}

Cleaned_iat <- data_iat %>%
  rename(subject = ID) 

```

## 11. Combine files into one master file for processing

```{r}

# Join the cleaned data files together into a master file

Study_1_data <- Cleaned_demographics %>% 
  full_join(Cleaned_method_factors, by = "subject") %>%
  full_join(Cleaned_ratings, by = "subject") %>% 
  full_join(Cleaned_intentions, by = "subject") %>%
  full_join(Cleaned_confidence, by = "subject") %>%
  full_join(Cleaned_demand, by = "subject") %>% 
  full_join(Cleaned_reactance, by = "subject")  %>%
  full_join(Cleaned_believability, by = "subject") %>%
  full_join(Cleaned_iat, by = "subject") 

# remove individuals with duplicate data
Study_1_data[duplicated(Study_1_data$subject), ]
Study_1_data <- Study_1_data[!duplicated(Study_1_data$subject), ]

# Drop participants who have incomplete data

Study_1_data <- Study_1_data %>% 
  drop_na(task_order, training_performance, IAT_D2) 

# At the moment the stimulus identity factor (Target 1 - good OR Target 1 - bad) leads to IAT effects that differ in their direction (for half of the participants the IAT score is in the positive direction and for the rest it is the negative direction). In order to control for this, I have reverse scored the IAT effects for those in the "Outcome_1_Target_1_Good_Outcome_2_Target_2_Bad" condition. Now a positive IAT score indicates that people preferred the Target that was related to the Positive Source more than the Target related to the Negative source. Negative values indicate the opposite preference pattern.


Study_1_data <- Study_1_data %>% 
  mutate(Transformed_IAT_D2 = ifelse(stimulus_identity == "Outcome_1_Target_1_Bad_Outcome_2_Target_2_Good", Reverse_Scored_IAT_D2 * -1, Reverse_Scored_IAT_D2))


```

## 12. Write to file

```{r}

write_csv2(Study_1_data, path = paste0(wd$output, "Study_1_Master_File.csv"))


```


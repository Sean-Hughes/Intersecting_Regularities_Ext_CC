---
title: "Study 5: Testing Phase (after Acquisition Phase)"
author: "Sean Hughes"
date: "30-5-2020"
output: 
  html_document:
    code_folding: hide
    highlight: haddock
    theme: flatly
    toc: yes 
    toc_float: yes
---

```{r include=FALSE}
knitr::opts_chunk$set(message=FALSE,
                      warning=FALSE)
```


# Load the necessary packages

```{r}
library(ggthemes)
library(foreign)
library(tidyverse)
library(Hmisc)
library(car)
library(readxl)
library(xlsx)
```

## 1. Import the raw data files from Excel into R

```{r}

wd <- list()
wd$data   <- "C:/Users/Sean/Desktop/Intersecting_Regularties_/Study 5/Raw_Data/"
wd$output <- "C:/Users/Sean/Desktop/Intersecting_Regularties_/Study 5/Processed_Data/"

raw_data_1 <- read_xlsx(paste0(wd$data, "testing_left_17_04_14.xlsx"), col_names = TRUE)
raw_data_2 <- read_xlsx(paste0(wd$data, "testing_left_rev_17_04_14.xlsx"), col_names = TRUE)
raw_data_3 <- read_xlsx(paste0(wd$data, "testing_right_17_04_14.xlsx"), col_names = TRUE)
raw_data_4 <- read_xlsx(paste0(wd$data, "testing_right_rev_17_04_14.xlsx"), col_names = TRUE)


```

## 2. Join the training files together

```{r}
# Note: there was only one block of testing - so no need to bring in the block number

processed_data_1 <- raw_data_1 %>% 
  filter(blockcode != "Begin") %>% 
  select(subject, trialnum, correct)

processed_data_2 <- raw_data_2 %>% 
  filter(blockcode != "Begin") %>% 
  select(subject, trialnum, correct)

processed_data_3 <- raw_data_3 %>% 
  filter(blockcode != "Begin") %>% 
  select(subject, trialnum, correct)

processed_data_4 <- raw_data_4 %>% 
  filter(blockcode != "Begin") %>% 
  select(subject, trialnum, correct)

combined_data <- processed_data_1 %>% 
  bind_rows(processed_data_2, processed_data_3, processed_data_4) %>%
  rename(trial_number = trialnum) %>% 
  arrange(subject)

```

## 3. Exclude incomplete data

```{r}

# Number of participants before exclusions

Participants_before_exclusions <- combined_data %>% 
  distinct(subject) %>% 
  count()

# Check to see if everyone has complete data for the four training blocks - if block_number = 280 then they do. Otherwise they do not. If they do not then remove them 

combined_data <- combined_data %>%
  group_by(subject) %>% 
  mutate(complete_data_check = sum(trial_number)) %>%
  filter(complete_data_check == 36) %>%
  ungroup() 

# Number of participants post exclusions

Participants_after_exclusions <- combined_data %>% 
  distinct(subject) %>% 
  count()


```

## 4. Calculating Mean and SD of Accuracy 

```{r}

# Calculate mean and SD for accuracy (i.e., the correct row) 

summarised_data <- combined_data %>%
  group_by(subject) %>% 
  summarise(mean_correct = mean(correct), sd_correct = sd(correct))%>%
  arrange(subject) %>%
  ungroup()

```

## 5. Identify those who failed the test phase (< 70%)

```{r}
# Step 1: Identify those that failed training
Fail_Group <- summarised_data %>% 
  filter(mean_correct < .70) %>%
  distinct(subject)

# Create a subset of the summarised data for the failed group
Fail_Group <- summarised_data %>% 
  semi_join(Fail_Group, by = "subject") %>%
  mutate(block_type = "Test_1", training_performance = "Fail")

```


## 6. Identify those who passed the training phase (> 70%)

```{r}

# Step 1: Identify those that passed training
Pass_Group <- summarised_data %>% 
  filter(mean_correct > .69) %>%
  distinct(subject)

# Create a subset of the summarised data for the pass group
Pass_Group <- summarised_data %>% 
  semi_join(Pass_Group, by = "subject") %>%
  mutate(block_type = "Test_1", training_performance = "Pass")


```

## 7. Graph accuracy across blocks for those who passed vs. failed

```{r}

# Combine the Pass and Fail Groups 

summarised_data  <- Pass_Group %>% 
  bind_rows(Fail_Group) %>% 
  arrange(subject)

# Pass_Group -> Calculate  Mean and SD for accuracy in each training block
  data_for_graph <- summarised_data %>% 
    group_by(training_performance) %>% 
    summarise(mean_accuracy = mean(mean_correct), sd_accuracy = sd(sd_correct))

# Graph Mean and SD accuracy across blocks
ggplot(data_for_graph, aes(x=training_performance, y=mean_accuracy)) +
    geom_bar(colour="black", stat="identity", position = position_dodge()) + geom_errorbar(aes(ymin=mean_accuracy-sd_accuracy, ymax=mean_accuracy+sd_accuracy), width=.2,
                 position=position_dodge(.9)) + theme_classic()

```

## 8. Merge the datasets

```{r}
#Write data back to disk in csv format.

Fail_Group <- summarised_data %>% 
  filter(mean_correct < .70) %>%
  distinct(subject) %>% 
  mutate(block_type = "Test_1", training_performance = "Fail")

Pass_Group <- summarised_data %>% 
  filter(mean_correct > .69) %>%
  distinct(subject) %>% 
  mutate(block_type = "Test_1", training_performance = "Pass")

Study_1_pass_fail_group <- Pass_Group %>% 
  bind_rows(Fail_Group) %>% 
  arrange(subject)

write_csv2(summarised_data, path = paste0(wd$output, "Study_5_Test_Phase_1.csv"))

```




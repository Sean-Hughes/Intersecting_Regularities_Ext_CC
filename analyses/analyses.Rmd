---
title: "IR, extinction, & counter conditioning"
subtitle: "Analyses & meta-analyses"
author: "Ian Hussey & Sean Hughes"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: 
  html_document:
    code_folding: hide
    highlight: haddock
    theme: flatly
    toc: yes 
    toc_float: yes
---

```{r include=FALSE}
knitr::opts_chunk$set(message=FALSE,
                      warning=FALSE)
```

# Dependencies & functions

```{r}

# dependencies -----
library(tidyverse)
library(ggthemes)
library(knitr)
library(kableExtra)
library(broom)
library(effsize)
library(BayesFactor)
library(metafor)
library(ez)
library(schoRsch)

# functions -----
# round p value using apa format
apa_p_value <- function(p){
  p_formatted <- ifelse(p >= 0.0001, paste("=", round(p, 4)),
                        ifelse(p < 0.0001, "< .0001", NA))
  p_formatted <- gsub(pattern = "0.", replacement = ".", x = p_formatted, fixed = TRUE)
  p_formatted
}

# calculate cohens d and return its output in tidy format - a helper function for analysis_workflow
tidy_cohens_d <- function(data){
  require(effsize)
  
  fit <- effsize::cohen.d(DV ~ IV, data = data)
  
  results <- tibble(cohens_d = fit$estimate,
                    cohens_d_ci_lower = fit$conf.int["lower"],
                    cohens_d_ci_upper = fit$conf.int["upper"])
  
  return(results)
}

# calculate cohens d and return its output in tidy format - a helper function for analysis_workflow
tidy_ttest_bf <- function(data){
  require(BayesFactor)
  
  fit <- data %>%
    ttestBF(formula = DV ~ IV, data = .)

  results <- data.frame(bf10 = extractBF(fit)$bf)
  return(results)
}


# full analysis workflow
# NB workflow returns mean_reference and mean_comparison, where reference is the first factor level and comparison is the next highest level.
analysis_workflow <- function(data){
  
  # frequentist t test
  results_t_test <- data %>%
    group_by(experiment, DV_type) %>%
    do(broom::tidy(t.test(DV ~ IV, data = .))) %>%
    ungroup() %>%
    rename(t = statistic,
           df = parameter,
           p = p.value,
           mean_reference = estimate1,
           mean_comaprison = estimate2)

  # cohens d
  results_cohens_d <- data %>%
    group_by(experiment, DV_type) %>%
    do(tidy_cohens_d(data = .)) %>%
    ungroup()
  
  # BF t test
  results_bf_t_test <- data %>%
    group_by(experiment, DV_type) %>%
    do(tidy_ttest_bf(data = .)) %>%
    ungroup()
  
  # combine
  results <- 
    full_join(results_t_test,
              results_cohens_d,
              by = c("experiment", "DV_type")) %>%
    full_join(results_bf_t_test,
              by = c("experiment", "DV_type")) %>%
    select(experiment, DV_type, 
           mean_reference, mean_comaprison, 
           t, df, p, cohens_d, cohens_d_ci_lower, cohens_d_ci_upper, bf10) %>%
    mutate(reportable_result = paste0("Reference group M = ", round(mean_reference, 2), ", comparison group M = ", round(mean_comaprison, 2), ", t(", round(df, 2), ") = ", round(t, 2), ", p ", apa_p_value(p), ", d = ", round(cohens_d, 2), ", 95% CI [", round(cohens_d_ci_lower, 2), ", ", round(cohens_d_ci_upper, 2), "], BF10 = ", round(bf10, 1)))
  
  return(results)
}

# add heterogeneity stats string for forest plot
add_heterogeneity_metrics_to_forest <- function(fit) {
  bquote(paste("RE Model (", tau^2, " = ", .(formatC(round(fit$tau2, 1))), 
               ", ", I^2, " = ", .(formatC(round(fit$I2, 1))),
               "%, ", H^2," = ", .(formatC(round(fit$H2, 1))), ")"))
}

```

# Data and exclusions

```{r}

# full data
data_processed <-
  bind_rows(
    read_csv("../data/Study 1/processed/data_processed.csv"),
    read_csv("../data/Study 2/processed/data_processed.csv"),
    read_csv("../data/Study 3/processed/data_processed.csv"),
    read_csv("../data/Study 4/processed/data_processed.csv"),
    read_csv("../data/Study 5/processed/data_processed.csv"),
    read_csv("../data/Study 6/processed/data_processed.csv"),
    read_csv("../data/Study 7/processed/data_processed.csv")
  ) %>%
  # set factor levels for t test comparisons
  mutate(experiment_condition = fct_relevel(experiment_condition,
                                            "acquisition_only", 
                                            "acquisition_and_extinction",
                                            "acquisition_and_counterconditioning"),
         stimulus_identity_condition = fct_relevel(stimulus_identity_condition,
                                                   "Outcome_1_Target_1_Good_Outcome_2_Target_2_Bad",
                                                   "Outcome_1_Target_1_Bad_Outcome_2_Target_2_Good")) %>%
  mutate(exclude = ifelse(completeness_acquisition_training == "complete" &
                            completeness_acquisition_testing == "complete" &
                            (completeness_extinction_training == "complete" | 
                               is.na(completeness_extinction_training)) &
                            (completeness_extinction_testing == "complete" | 
                               is.na(completeness_extinction_testing)) &
                            (completeness_counterconditioning_training == "complete" |
                               is.na(completeness_counterconditioning_training)) &
                            (completeness_counterconditioning_testing == "complete" |
                               is.na(completeness_counterconditioning_testing)) &
                            complete_iat_data == "complete" &
                            passed_iat_performance == TRUE,
                          FALSE, TRUE))

# exclusions
data_processed_after_exclusions <- data_processed %>%
  filter(exclude == FALSE)

```

# Demographics

, na.rm = TRUE shouldn't be needed, check data processing

why are there 49 participants in an unknown experiment?

```{r}

data_processed %>%
  group_by(experiment) %>%
  summarize(n = n(),
            age_mean = mean(age, na.rm = TRUE),
            age_sd = mean(age, na.rm = TRUE),
            excluded_n = sum(exclude, na.rm = TRUE),
            excluded_percent = mean(exclude*100, na.rm = TRUE)) %>%
  mutate_if(is.numeric, round, digits = 1)

```

# Training and testing mastery

## Percentage accuracy

```{r fig.height=10, fig.width=7}

results_training_and_testing_percent_accuracy <- data_processed_after_exclusions %>% 
  select(unique_id, experiment, 
         mean_correct_acquisition_training,         mean_correct_acquisition_testing, 
         mean_correct_extinction_training,          mean_correct_extinction_testing, 
         mean_correct_counterconditioning_training, mean_correct_counterconditioning_testing) %>%
  gather(phase, mean_correct, c(mean_correct_acquisition_training, mean_correct_acquisition_testing, 
                                mean_correct_extinction_training, mean_correct_extinction_testing, 
                                mean_correct_counterconditioning_training, mean_correct_counterconditioning_testing)) %>%
  distinct(unique_id, phase, .keep_all = TRUE) %>%
  drop_na() %>%
  mutate(phase = dplyr::recode(phase, 
                               "mean_correct_acquisition_testing" = "Acquisition\ntest",
                               "mean_correct_acquisition_training" = "Acquisition\ntraining",
                               "mean_correct_extinction_testing" = "Extinction\ntesting",			
                               "mean_correct_extinction_training" = "Extinction\ntraining")) %>%
  group_by(experiment, phase) %>% 
  dplyr::summarise(mean_accuracy = mean(mean_correct*100, na.rm = TRUE), 
                   sd_accuracy = sd(mean_correct*100, na.rm = TRUE)) %>%
  ungroup()

results_training_and_testing_percent_accuracy %>%
  mutate_if(is.numeric, round, digits = 0) %>%
  mutate(result = paste0(mean_accuracy, " (", sd_accuracy, ")")) %>%
  select(-mean_accuracy, -sd_accuracy) %>%
  spread(phase, result) %>%
  kable() %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE)
  
# ggplot(results_training_and_testing_percent_accuracy, aes(x = phase, y = mean_accuracy)) +
#   geom_bar(colour = "black", stat = "identity") + 
#   geom_errorbar(aes(ymin = mean_accuracy - sd_accuracy, ymax = mean_accuracy + sd_accuracy), 
#                 width = .2) + 
#   theme_classic() +
#   facet_wrap(~experiment, ncol = 1)

```

## Percentage pass

```{r fig.height=10, fig.width=7}

results_training_and_testing_percent_pass <- data_processed_after_exclusions %>% 
  select(unique_id, experiment, 
         passed_performance_criterion_acquisition_training,         passed_performance_criterion_acquisition_testing, 
         passed_performance_criterion_extinction_training,          passed_performance_criterion_extinction_testing, 
         passed_performance_criterion_counterconditioning_training, passed_performance_criterion_counterconditioning_testing) %>%
  gather(phase, passed_performance_criterion, c(passed_performance_criterion_acquisition_training,
                                                passed_performance_criterion_acquisition_testing, 
                                                passed_performance_criterion_extinction_training,
                                                passed_performance_criterion_extinction_testing, 
                                                passed_performance_criterion_counterconditioning_training,
                                                passed_performance_criterion_counterconditioning_testing)) %>%
  distinct(unique_id, phase, .keep_all = TRUE) %>%
  drop_na() %>%
  mutate(phase = dplyr::recode(phase, 
                               "passed_performance_criterion_acquisition_testing" = "Acquisition\ntest",
                               "passed_performance_criterion_acquisition_training" = "Acquisition\ntraining",
                               "passed_performance_criterion_extinction_testing" = "Extinction\ntesting",			
                               "passed_performance_criterion_extinction_training" = "Extinction\ntraining")) %>%
  group_by(experiment, phase) %>% 
  dplyr::summarise(percent_passed = mean(passed_performance_criterion*100, na.rm = TRUE)) %>%
  ungroup()

results_training_and_testing_percent_pass %>%
  mutate_if(is.numeric, round, digits = 0) %>%
  spread(phase, percent_passed) %>%
  kable() %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE)
  
```

# Analyses by study

## Was there an IR effect?

- by DV
- Differences between stimulus identity, using only the acquisition_only condition.

```{r}

results_basic_effect <- data_processed_after_exclusions %>%
  filter(experiment_condition == "acquisition_only") %>%
  rename(IV = stimulus_identity_condition) %>%
  gather(DV_type, DV, c(self_reported_OEC_effect, self_reported_IR_effect, IAT_D2)) %>%
  select(experiment, DV_type, DV, IV) %>%
  drop_na() %>%
  analysis_workflow(data = .)

results_basic_effect %>%
  select(experiment, DV_type, reportable_result) %>%
  kable() %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE)

```

## Was the IR moderated by extinction?

- by DV
- Differences between experiment conditions, after reverse scoring for stimulus identity.

```{r}

results_moderation_by_extinction <- data_processed_after_exclusions %>%
  filter(experiment_condition %in% c("acquisition_only", "acquisition_and_extinction") & 
           experiment %in% c(1, 2, 3, 4, 7)) %>%
  rename(IV = experiment_condition) %>%
  gather(DV_type, DV, c(self_reported_OEC_effect_controlling_stimulus_identity, 
                        self_reported_IR_effect_controlling_stimulus_identity, 
                        IAT_D2_controlling_stimulus_identity)) %>%
  select(experiment, DV_type, DV, IV) %>%
  drop_na() %>%
  analysis_workflow(data = .)

results_moderation_by_extinction %>%
  select(experiment, DV_type, reportable_result) %>%
  kable() %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE)

```

## Was the IR moderated by counter conditioning?

- by DV
- Differences between experiment conditions, after reverse scoring for stimulus identity.

```{r}

results_moderation_by_counterconditioning <- data_processed_after_exclusions %>%
  filter(experiment_condition %in% c("acquisition_only", "acquisition_and_counterconditioning") & 
           experiment %in% c(5, 6, 7)) %>%
  rename(IV = experiment_condition) %>%
  gather(DV_type, DV, c(self_reported_OEC_effect_controlling_stimulus_identity, 
                        self_reported_IR_effect_controlling_stimulus_identity, 
                        IAT_D2_controlling_stimulus_identity)) %>%
  select(experiment, DV_type, DV, IV) %>%
  drop_na() %>%
  analysis_workflow(data = .)

results_moderation_by_counterconditioning %>%
  select(experiment, DV_type, reportable_result) %>%
  kable() %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE)

```

## Study 7 ANOVA

drop_na SHOULDN'T BE NEEDED ??

```{r}

data_study_7 <- data_processed_after_exclusions %>%
  filter(experiment == 7) %>%
  select(unique_id,
         self_reported_IR_effect_controlling_stimulus_identity,
         self_reported_OEC_effect_controlling_stimulus_identity,
         IAT_D2_controlling_stimulus_identity,
         experiment_condition) %>%
  drop_na()

# IAT
fit_study_7_iat <- ez::ezANOVA(data     = data_study_7,
                               dv       = IAT_D2_controlling_stimulus_identity,
                               between  = experiment_condition,
                               wid      = unique_id,
                               type     = 3,
                               detailed = TRUE)

 
  
# IR
fit_study_7_ir <- ez::ezANOVA(data     = data_study_7,
                              dv       = self_reported_IR_effect_controlling_stimulus_identity,
                              between  = experiment_condition,
                              wid      = unique_id,
                              type     = 3,
                              detailed = TRUE)

# OEC
fit_study_7_oec <- ez::ezANOVA(data     = data_study_7,
                               dv       = self_reported_OEC_effect_controlling_stimulus_identity,
                               between  = experiment_condition,
                               wid      = unique_id,
                               type     = 3,
                               detailed = TRUE)

# combine results
results_study_7 <- 
  bind_rows(anova_out(fit_study_7_iat, 
                      etasq = "partial", 
                      print = FALSE)$`--- FORMATTED RESULTS ------------------------------------` %>%
              mutate(DV = "IAT"),
            anova_out(fit_study_7_ir, 
                      etasq = "partial", 
                      print = FALSE)$`--- FORMATTED RESULTS ------------------------------------` %>%
              mutate(DV = "IR"),
            anova_out(fit_study_7_oec, 
                      etasq = "partial", 
                      print = FALSE)$`--- FORMATTED RESULTS ------------------------------------` %>%
              mutate(DV = "OEC")) %>%
  filter(Effect == "experiment_condition") %>%
  select(DV, Text)

results_study_7 %>%
  kable() %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE)

```

# Meta-analyses

## Basic effect

```{r}

results_for_meta_basic_effect <- results_basic_effect %>%
  rename(yi = cohens_d) %>%
  mutate(sei = (cohens_d_ci_upper - cohens_d_ci_lower)/(2*1.96)) %>%
  select(experiment, DV_type, yi, sei)

# iat
fit_basic_effect_iat <- results_for_meta_basic_effect %>%
  filter(str_detect(DV_type, "IAT_D2")) %>%
  rma(yi = yi,
      sei = sei,
      data = .,
      slab = experiment)

metafor::forest(fit_basic_effect_iat,
                xlab = "Cohen's d",
                addcred = TRUE,
                refline = 0,
                xlim = c(-1.5, 4),
                at = c(-0.5, 0, 0.5, 1.0, 1.5, 2.0, 2.5))
text(-1.5, 9, "IAT", pos = 4)
text(4, 9, "d [95% CI]", pos = 2)

# IR
fit_basic_effect_ir <- results_for_meta_basic_effect %>%
  filter(str_detect(DV_type, "_IR_")) %>%
  rma(yi = yi,
      sei = sei,
      data = .,
      slab = experiment)

metafor::forest(fit_basic_effect_ir,
                xlab = "Cohen's d",
                addcred = TRUE,
                refline = 0,
                xlim = c(-1.5, 4),
                at = c(-0.5, 0, 0.5, 1.0, 1.5, 2.0, 2.5))
text(-1.5, 9, "IR", pos = 4)
text(4, 9, "d [95% CI]", pos = 2)

# OEC
fit_basic_effect_oec <- results_for_meta_basic_effect %>%
  filter(str_detect(DV_type, "_OEC_")) %>%
  rma(yi = yi,
      sei = sei,
      data = .,
      slab = experiment)

metafor::forest(fit_basic_effect_oec,
                xlab = "Cohen's d",
                addcred = TRUE,
                refline = 0,
                xlim = c(-1.5, 4),
                at = c(-0.5, 0, 0.5, 1.0, 1.5, 2.0, 2.5))
text(-1.5, 9, "OEC", pos = 4)
text(4, 9, "d [95% CI]", pos = 2)

```

## Moderation by extinction

```{r}

results_for_meta_extinction <- results_moderation_by_extinction %>%
  rename(yi = cohens_d) %>%
  mutate(sei = (cohens_d_ci_upper - cohens_d_ci_lower)/(2*1.96)) %>%
  select(experiment, DV_type, yi, sei)

# iat
fit_moderation_extinction_iat <- results_for_meta_extinction %>%
  filter(str_detect(DV_type, "IAT_D2")) %>%
  rma(yi = yi,
      sei = sei,
      data = .,
      slab = experiment)

metafor::forest(fit_moderation_extinction_iat,
                xlab = "Cohen's d",
                addcred = TRUE,
                refline = 0,
                xlim = c(-2.25, 2.25),
                at = c(-1.5, -1.0, -0.5, 0, 0.5, 1.0))
text(-2.25, 7, "IAT", pos = 4)
text(2.25, 7, "d [95% CI]", pos = 2)

# IR
fit_moderation_extinction_ir <- results_for_meta_extinction %>%
  filter(str_detect(DV_type, "_IR_")) %>%
  rma(yi = yi,
      sei = sei,
      data = .,
      slab = experiment)

metafor::forest(fit_moderation_extinction_ir,
                xlab = "Cohen's d",
                addcred = TRUE,
                refline = 0,
                xlim = c(-2.25, 2.25),
                at = c(-1.5, -1.0, -0.5, 0, 0.5, 1.0))
text(-2.25, 7, "IR", pos = 4)
text(2.25, 7, "d [95% CI]", pos = 2)

# OEC
fit_moderation_extinction_oec <- results_for_meta_extinction %>%
  filter(str_detect(DV_type, "_OEC_")) %>%
  rma(yi = yi,
      sei = sei,
      data = .,
      slab = experiment)

metafor::forest(fit_moderation_extinction_oec,
                xlab = "Cohen's d",
                addcred = TRUE,
                refline = 0,
                xlim = c(-2.25, 2.25),
                at = c(-1.5, -1.0, -0.5, 0, 0.5, 1.0))
text(-2.25, 7, "OEC", pos = 4)
text(2.25, 7, "d [95% CI]", pos = 2)

```

## Moderation by counter conditioning

```{r}

results_for_meta_counterconditioning <- results_moderation_by_counterconditioning %>%
  rename(yi = cohens_d) %>%
  mutate(sei = (cohens_d_ci_upper - cohens_d_ci_lower)/(2*1.96)) %>%
  select(experiment, DV_type, yi, sei)

# iat
fit_moderation_extinction_iat <- results_for_meta_counterconditioning %>%
  filter(str_detect(DV_type, "IAT_D2")) %>%
  rma(yi = yi,
      sei = sei,
      data = .,
      slab = experiment)

metafor::forest(fit_moderation_extinction_iat,
                xlab = "Cohen's d",
                addcred = TRUE,
                refline = 0,
                xlim = c(-2.25, 2.25),
                at = c(-1.5, -1.0, -0.5, 0, 0.5, 1.0))
text(-2.25, 7, "IAT", pos = 4)
text(2.25, 7, "d [95% CI]", pos = 2)

# IR
fit_moderation_extinction_ir <- results_for_meta_counterconditioning %>%
  filter(str_detect(DV_type, "_IR_")) %>%
  rma(yi = yi,
      sei = sei,
      data = .,
      slab = experiment)

metafor::forest(fit_moderation_extinction_ir,
                xlab = "Cohen's d",
                addcred = TRUE,
                refline = 0,
                xlim = c(-2.25, 2.25),
                at = c(-1.5, -1.0, -0.5, 0, 0.5, 1.0))
text(-2.25, 7, "IR", pos = 4)
text(2.25, 7, "d [95% CI]", pos = 2)

# OEC
fit_moderation_extinction_oec <- results_for_meta_counterconditioning %>%
  filter(str_detect(DV_type, "_OEC_")) %>%
  rma(yi = yi,
      sei = sei,
      data = .,
      slab = experiment)

metafor::forest(fit_moderation_extinction_oec,
                xlab = "Cohen's d",
                addcred = TRUE,
                refline = 0,
                xlim = c(-2.25, 2.25),
                at = c(-1.5, -1.0, -0.5, 0, 0.5, 1.0))
text(-2.25, 7, "OEC", pos = 4)
text(2.25, 7, "d [95% CI]", pos = 2)

```

# Sensitivity meta-analyses

duplicate the above metas once finsihed, adding the following filters:

passed_performance_criterion_acquisition_training == TRUE &
passed_performance_criterion_acquisition_testing == TRUE &

# to do

- demographics SUGGESTS THERE ARE REMAINING PROCESSING ISSUES - , na.rm = TRUE shouldn't be needed
- counterconditioning analysis returns NaN for cohens d, no idea why. cant apply meta analyses until its fixed.
- check if there are any issues with the data processing for the pass rate in studies 3 and 7 extinction testing - they're oddly low
- study 7 participants could have extra training and testing data depending on performance. currently this is excluded, but it should be used. change data processing.
- study 7 data processing needs attention for other unknown reasons: why are there multiple rows with the same unique id in the processed data? why do the Ns for the extinction and counterconditioning training and testing processed data equal the acquisition phase, when only one third of people should have done CC and extinction (each).
- handle between study differences
  - remove the for testing filter call in data processing!
  - training and testing percent passes etc need code added to handle CC
- separate workflow for intentions (multinominal logistic)
- sensitivity meta analyses for training and testing exclusions
- add anova for study 7
- separate reading in of data and exclusions, do demographics descriptives before exclusions








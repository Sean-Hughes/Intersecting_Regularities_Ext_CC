---
title: "Data processing"
author: "Sean Hughes & Ian Hussey"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: 
  html_document:
    code_folding: hide
    highlight: haddock
    theme: flatly
    toc: yes 
    toc_float: yes
---

# to dos

- why is task_order discerned from stimulus_ratings_before_17_03_17.xlsx and after? why are there missing values?
- exploratory_questions_17_03_17.xlsx currently not used
- reverse scoring done for self reported ratings, but what about other self-reports and iats?

```{r include=FALSE}
knitr::opts_chunk$set(message=FALSE,
                      warning=FALSE)
```

# Dependencies

```{r}

library(tidyverse)
library(readxl)
library(ggthemes)
library(knitr)
library(kableExtra)

```

# Conditions

Some experimental conditions are not recorded in the data produced by inquisit but are discerned by the file names they come from, or the presence or absence of one phase of data. Extract this here. 

The_training conditions are defined by which file the data come from:

intersecting_regularities_left_17_03_17.xlsx & 
intersecting_regularities_right_17_03_17.xlsx: 
- Outcome 1 and Target 1 are Good/ Outcome 2 and Target 2 are Bad

intersecting_regularities_left_rev_17_03_17.xlsx & 
intersecting_regularities_right_rev_17_03_17.xlsx: 
- Outcome 1 and Target 1 are Bad/ Outcome 2 and Target 2 are Good


```{r}

# stimulus identity using acquisition_training file names
data_stimulus_identity_condition <- 
  bind_rows(
    read_xlsx("raw/intersecting_regularities_left_17_03_17.xlsx") %>%
      mutate(stimulus_identity_condition = "Outcome_1_Target_1_Good_Outcome_2_Target_2_Bad"),
    read_xlsx("raw/intersecting_regularities_right_17_03_17.xlsx") %>%
      mutate(stimulus_identity_condition = "Outcome_1_Target_1_Good_Outcome_2_Target_2_Bad"),
    read_xlsx("raw/intersecting_regularities_left_rev_17_03_17.xlsx") %>%
      mutate(stimulus_identity_condition = "Outcome_1_Target_1_Bad_Outcome_2_Target_2_Good"),
    read_xlsx("raw/intersecting_regularities_right_rev_17_03_17.xlsx") %>%
      mutate(stimulus_identity_condition = "Outcome_1_Target_1_Bad_Outcome_2_Target_2_Good")
  ) %>%
  select(subject, stimulus_identity_condition) %>%
  distinct(subject, .keep_all = TRUE)

# stimulus identity using presence of extinction phase files
data_extinction_condition <- 
  bind_rows(
    #_training
    read_xlsx("raw/extinction1a_intersecting_regularities_left_17_03_17.xlsx") %>% 
      mutate(response = as.character(response)),
    read_xlsx("raw/extinction1a_intersecting_regularities_left_rev_17_03_17.xlsx") %>% 
      mutate(response = as.character(response)),
    read_xlsx("raw/extinction1a_intersecting_regularities_right_17_03_17.xlsx") %>% 
      mutate(response = as.character(response)),
    read_xlsx("raw/extinction1a_intersecting_regularities_right_rev_17_03_17.xlsx") %>% 
      mutate(response = as.character(response)),
    #_testing
    read_xlsx("raw/testing_left1a_17_03_17.xlsx") %>% 
      mutate(response = as.character(response)),
    read_xlsx("raw/testing_left1a_rev_17_03_17.xlsx") %>% 
      mutate(response = as.character(response)),
    read_xlsx("raw/testing_right1a_17_03_17.xlsx") %>% 
      mutate(response = as.character(response)),
    read_xlsx("raw/testing_right1a_rev_17_03_17.xlsx") %>% 
      mutate(response = as.character(response))
  ) %>%
  mutate(extinction_condition = "acquisition and extinction") %>%
  select(subject, extinction_condition) %>%
  distinct(subject, .keep_all = TRUE)

# task order
data_task_order <- 
  bind_rows(read_xlsx("raw/stimulus_ratings_before_17_03_17.xlsx") %>% 
              select(subject) %>% 
              mutate(task_order = "Explicits First"),
            read_xlsx("raw/stimulus_ratings_after_17_03_17.xlsx") %>% 
              select(subject) %>% 
              mutate(task_order = "Implicits First"))

# combine
data_conditions <- data_stimulus_identity_condition %>%
  full_join(data_extinction_condition, by = "subject") %>%
  full_join(data_task_order, by = "subject") %>%
  mutate(experiment = 1,
         extinction_condition = ifelse(is.na(extinction_condition), "acquisition only", extinction_condition))

rm(data_stimulus_identity_condition, data_extinction_condition, data_task_order)

```

# Demographics

```{r}

data_demographics <- read_xlsx("raw/demographics_17_03_17.xlsx") %>%
  select(subject, trialcode, response) %>% 
  pivot_wider(names_from = trialcode,
              values_from = response) %>%
  mutate(gender = case_when(str_detect(tolower(gender), "f") ~ "F",
                            str_detect(tolower(gender), "female") ~ "F",
                            str_detect(tolower(gender), "m") ~ "M",
                            str_detect(tolower(gender), "male") ~ "M",
                            TRUE ~ gender)) 

```

# Training and testing 

## Get data and tidy

```{r}

data_input <- 
  bind_rows(
    # acquisition_training 
    bind_rows(
      read_xlsx("raw/intersecting_regularities_left_17_03_17.xlsx"),
      read_xlsx("raw/intersecting_regularities_right_17_03_17.xlsx"),
      read_xlsx("raw/intersecting_regularities_left_rev_17_03_17.xlsx"),
      read_xlsx("raw/intersecting_regularities_right_rev_17_03_17.xlsx")
    ) %>%
      mutate(phase = "acquisition_training",
             blocknum = blocknum-1,
             response = as.character(response)),
    
    # acquisition test 
    bind_rows(
      read_xlsx("raw/testing_left_17_03_17.xlsx"),
      read_xlsx("raw/testing_left_rev_17_03_17.xlsx"),
      read_xlsx("raw/testing_right_17_03_17.xlsx"),
      read_xlsx("raw/testing_right_rev_17_03_17.xlsx")
    ) %>%
      mutate(phase = "acquisition_testing",
             response = as.character(response)),
    
    # extinction_training
    bind_rows(
      read_xlsx("raw/extinction1a_intersecting_regularities_left_17_03_17.xlsx"),
      read_xlsx("raw/extinction1a_intersecting_regularities_left_rev_17_03_17.xlsx"),
      read_xlsx("raw/extinction1a_intersecting_regularities_right_17_03_17.xlsx"),
      read_xlsx("raw/extinction1a_intersecting_regularities_right_rev_17_03_17.xlsx")
    ) %>%
      mutate(phase = "extinction_training",
             response = as.character(response)),
    
    # extinction test 
    bind_rows(
      read_xlsx("raw/testing_left1a_17_03_17.xlsx"),
      read_xlsx("raw/testing_left1a_rev_17_03_17.xlsx"),
      read_xlsx("raw/testing_right1a_17_03_17.xlsx"),
      read_xlsx("raw/testing_right1a_rev_17_03_17.xlsx")
    ) %>%
      mutate(phase = "extinction_testing",
             response = as.character(response))
  ) %>%
  filter(blockcode != "Begin") %>% 
  select(subject, phase, block_number = blocknum, trial_number = trialnum, correct) %>%
  arrange(subject, phase)

```

## Completeness

```{r}

data_completeness_temp <- data_input %>%
  group_by(subject, phase) %>%
  summarize(n = n()) %>%
  mutate(complete_training_testing_data = 
           case_when((phase == "acquisition_training" & n == 80) |
                       (phase == "acquisition_testing" & n == 8) |
                       (phase == "extinction_training" & n == 80) |
                       (phase == "extinction_testing" & n == 8) ~ "complete", 
                     (phase == "acquisition_training" & n > 80) |
                       (phase == "acquisition_testing" & n > 8) |
                       (phase == "extinction_training" & n > 80) |
                       (phase == "extinction_testing" & n > 8) ~ "excess", 
                     (phase == "acquisition_training" & n < 80) |
                       (phase == "acquisition_testing" & n < 8) |
                       (phase == "extinction_training" & n < 80) |
                       (phase == "extinction_testing" & n < 8) ~ "partial")) %>%
  ungroup() %>%
  select(-n) 

data_completeness_temp %>%
  count(phase, complete_training_testing_data) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE)

data_completeness <- data_completeness_temp %>%
  pivot_wider(names_from = phase, 
              values_from = complete_training_testing_data,
              names_prefix = "completeness_")

```

## Performance

```{r}

data_performance_temp <- data_input %>%
  # summarize performance by block
  group_by(subject, phase, block_number) %>% 
  summarise(mean_correct = mean(correct), 
            sd_correct = sd(correct)) %>%
  mutate(passed_performance_criterion_by_block = ifelse(mean_correct < .75, FALSE, TRUE)) %>%
  ungroup() %>% 
  # summarize performance by participant (final block only)
  group_by(subject, phase) %>% 
  mutate(passed_performance_criterion = ifelse(block_number == max(block_number) & passed_performance_criterion_by_block == TRUE, TRUE, FALSE)) %>%
  ungroup() %>%
  mutate(phase = fct_relevel(phase,
                             "extinction_testing",
                             "extinction_training",
                             "acqusitiion_testing",
                             "acqusitiion_training")) %>%
  drop_na()

# plot
data_performance_temp %>% 
  group_by(phase, block_number, passed_performance_criterion_by_block) %>% 
  summarise(mean_accuracy = mean(mean_correct), sd_accuracy = sd(sd_correct)) %>%
  ggplot(aes(x=block_number, y=mean_accuracy, fill = passed_performance_criterion_by_block)) +
  geom_bar(colour="black", stat="identity", position = position_dodge()) + 
  geom_errorbar(aes(ymin=mean_accuracy-sd_accuracy, ymax=mean_accuracy+sd_accuracy), width=.2,
                position=position_dodge(.9)) + theme_classic() +
  facet_wrap(~phase, ncol = 1)


data_performance <- data_performance_temp %>%
  group_by(subject, phase) %>% 
  filter(block_number == max(block_number)) %>%
  ungroup() %>%
  select(-block_number, -passed_performance_criterion_by_block, -sd_correct) %>%
  pivot_wider(names_from = phase,
              values_from = c(mean_correct, passed_performance_criterion))

```

- NB because the last block each participant completes is selected, if participants have partial data, their means refer to their last completed block not the ultimate block. therefore ensure that partial data exclusions are done.

# Self-reports

```{r}

data_demand <- read_xlsx("raw/demand_17_03_17.xlsx") %>% 
  mutate(demand_response = case_when(Demand_response == "What I learned during the experiment" ~ "Not Demand Compliant",
                                     Demand_response == "I don't know why I evaluated the items as I did" ~ "Not Demand Compliant",
                                     Demand_response == "What I learned during the experiment" ~ "Not Demand Compliant",
                                     Demand_response == "What I thought the experimenter wanted me to say" ~ "Demand Compliant",
                                     Demand_response == "I based my ratings on some some factor that was not what I learned or what the experimenter wanted me to do" ~ "Not Demand Compliant")) %>%
  select(subject, demand_response)

data_reactance <- read_xlsx("raw/reactance_17_03_17.xlsx") %>% 
  select(subject, 
         reactance_response_1 = react1_response, 
         reactance_response_2 = react2_response) %>%
  mutate(reactance_response_2 = str_remove_all(reactance_response_2, "[^0-9]"))

data_believability <- read_xlsx("raw/cover_belief_17_03_17.xlsx") %>% 
  select(subject, 
         believability_response_1 = belief1_response, 
         believability_response_2 = belief2_response) %>%
  mutate(believability_response_2 = str_remove_all(believability_response_2, "[^0-9]"))

data_confidence_ratings <- read_xlsx("raw/confidence_ratings_17_03_17.xlsx") %>% 
  select(subject, 
         confidence_stim_1 = Stimulus_1_Confidence_Confidence_response, 
         confidence_stim_2 = Stimulus_2_Confidence_Confidence_response, 
         confidence_stim_3 = Stimulus_3_Confidence_Confidence_response, 
         confidence_stim_4 = Stimulus_4_Confidence_Confidence_response)

data_ratings <- read_xlsx("raw/valence_ratings_17_03_17.xlsx") %>% 
  select(subject, 
         Outcome_1_Pos_Neg = Stimulus_1_Positive_Negative_Positive_Negative_response,
         Outcome_1_Good_Bad = Stimulus_1_Good_Bad_Good_Bad_response,
         Outcome_1_Pleasant_Unpleasant = Stimulus_1_Pleasant_Unpleasant_Pleasant_Unpleasant_response,
         Outcome_1_Like_Dislike = Stimulus_1_Like_Dislike_Like_Dislike_response,
         Outcome_2_Pos_Neg = Stimulus_3_Positive_Negative_Positive_Negative_response,
         Outcome_2_Good_Bad = Stimulus_3_Good_Bad_Good_Bad_response, 
         Outcome_2_Pleasant_Unpleasant = Stimulus_3_Pleasant_Unpleasant_Pleasant_Unpleasant_response,
         Outcome_2_Like_Dislike = Stimulus_3_Like_Dislike_Like_Dislike_response,
         Target_1_Pos_Neg = Stimulus_2_Positive_Negative_Positive_Negative_response,
         Target_1_Good_Bad = Stimulus_2_Good_Bad_Good_Bad_response, 
         Target_1_Pleasant_Unpleasant = Stimulus_2_Pleasant_Unpleasant_Pleasant_Unpleasant_response,
         Target_1_Like_Dislike = Stimulus_2_Like_Dislike_Like_Dislike_response,
         Target_2_Pos_Neg = Stimulus_4_Positive_Negative_Positive_Negative_response,
         Target_2_Good_Bad = Stimulus_4_Good_Bad_Good_Bad_response,
         Target_2_Pleasant_Unpleasant = Stimulus_4_Pleasant_Unpleasant_Pleasant_Unpleasant_response,
         Target_2_Like_Dislike = Stimulus_4_Like_Dislike_Like_Dislike_response) %>% 
  # Create a mean rating score for each stimulus
  # Create an operant evaluative conditioning (OEC) and intersecting regularites (IR) effect
  rowwise() %>%
  mutate(mean_outcome_1 = mean(c(Outcome_1_Pos_Neg, Outcome_1_Good_Bad, Outcome_1_Pleasant_Unpleasant, Outcome_1_Like_Dislike)),
         mean_outcome_2 = mean(c(Outcome_2_Pos_Neg, Outcome_2_Good_Bad, Outcome_2_Pleasant_Unpleasant, Outcome_2_Like_Dislike)),
         mean_target_1  = mean(c(Target_1_Pos_Neg, Target_1_Good_Bad, Target_1_Pleasant_Unpleasant, Target_1_Like_Dislike)),
         mean_target_2  = mean(c(Target_2_Pos_Neg, Target_2_Good_Bad, Target_2_Pleasant_Unpleasant, Target_2_Like_Dislike)),
         OEC_effect_native     = mean_outcome_1 - mean_outcome_2,
         IR_effect_native      = mean_target_1 - mean_target_2) %>%
  ungroup() %>%
  select(subject, OEC_effect_native, IR_effect_native)

# behavioural intentions
data_intentions <- 
  full_join(read_xlsx("raw/intention_ratings_1_3_17_03_17.xlsx") %>%
              select(subject, intentions_response_1_3 = Intentions_1_3_response),
            read_xlsx("raw/intention_ratings_2_4_17_03_17.xlsx") %>%
              select(subject, intentions_response_2_4 = Intentions_2_4_response),
            by = "subject")

```

# Combine and write to disk

```{r}

data_processed <- data_conditions %>%
  full_join(data_demographics, by = "subject") %>%
  full_join(data_completeness, by = "subject") %>%
  full_join(data_performance, by = "subject") %>%
  full_join(data_demand, by = "subject") %>%
  full_join(data_reactance, by = "subject") %>%
  full_join(data_confidence_ratings, by = "subject") %>%
  full_join(data_believability, by = "subject") %>%
  full_join(data_ratings, by = "subject") %>%
  full_join(data_intentions, by = "subject") %>%
  select(experiment, 
         subject, 
         age, 
         gender, 
         stimulus_identity_condition, 
         extinction_condition, 
         task_order, 
         completeness_acquisition_testing, completeness_acquisition_training, 
         completeness_extinction_testing, completeness_extinction_training, 
         mean_correct_acquisition_training, mean_correct_acquisition_testing, 
         mean_correct_extinction_testing, mean_correct_extinction_training, 
         passed_performance_criterion_acquisition_training, passed_performance_criterion_acquisition_testing, 
         passed_performance_criterion_extinction_testing, passed_performance_criterion_extinction_training, 
         OEC_effect_native, IR_effect_native, 
         intentions_response_1_3, intentions_response_2_4,
         demand_response, 
         reactance_response_1, reactance_response_2, 
         confidence_stim_1, confidence_stim_2, confidence_stim_3, confidence_stim_4,
         believability_response_1, believability_response_2) %>%
  # reverse-score the scores the self-reports based on stimulus_identity_condition
  mutate(
    OEC_effect = case_when(
      stimulus_identity_condition == "Outcome_1_Target_1_Bad_Outcome_2_Target_2_Good" ~ OEC_effect_native,
      stimulus_identity_condition == "Outcome_1_Target_1_Good_Outcome_2_Target_2_Bad" ~ OEC_effect_native*-1
    ),
    IR_effect = case_when(
      stimulus_identity_condition == "Outcome_1_Target_1_Bad_Outcome_2_Target_2_Good" ~ IR_effect_native,
      stimulus_identity_condition == "Outcome_1_Target_1_Good_Outcome_2_Target_2_Bad" ~ IR_effect_native*-1
    )
  ) 
  # reverse score IAT so that a positive IAT score indicates that people preferred the Target that was related to the Positive Source more than the Target related to the Negative source and vice versa
  # mutate(Transformed_IAT_D2 = ifelse(stimulus_identity == "Outcome_1_Target_1_Bad_Outcome_2_Target_2_Good", Reverse_Scored_IAT_D2 * -1, Reverse_Scored_IAT_D2))


# write to disk
write_csv(data_processed, "processed/data_processed.csv")

```




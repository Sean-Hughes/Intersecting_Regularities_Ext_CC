---
title: "Data processing"
author: "Sean Hughes & Ian Hussey"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: 
  html_document:
    code_folding: hide
    highlight: haddock
    theme: flatly
    toc: yes 
    toc_float: yes
---

# to dos

- NA

```{r include=FALSE}
knitr::opts_chunk$set(message=FALSE,
                      warning=FALSE)
```

# Dependencies

```{r}

library(tidyverse)
library(readxl)
library(ggthemes)
library(knitr)
library(kableExtra)

```

# Conditions

Some experimental conditions are not recorded in the data produced by inquisit but are discerned by the file names they come from, or the presence or absence of one phase of data. Extract this here. 

The_training conditions are defined by which file the data come from:

intersecting_regularities_left_17_03_17.xlsx & 
intersecting_regularities_right_17_03_17.xlsx: 
- Outcome 1 and Target 1 are Good/ Outcome 2 and Target 2 are Bad

intersecting_regularities_left_rev_17_03_17.xlsx & 
intersecting_regularities_right_rev_17_03_17.xlsx: 
- Outcome 1 and Target 1 are Bad/ Outcome 2 and Target 2 are Good


```{r}

# stimulus identity using acquisition_training file names
data_stimulus_identity_condition <- 
  bind_rows(
    read_xlsx("raw/intersecting_regularities_left_17_03_17.xlsx") %>%
      mutate(stimulus_identity_condition = "Outcome_1_Target_1_Good_Outcome_2_Target_2_Bad"),
    read_xlsx("raw/intersecting_regularities_right_17_03_17.xlsx") %>%
      mutate(stimulus_identity_condition = "Outcome_1_Target_1_Good_Outcome_2_Target_2_Bad"),
    read_xlsx("raw/intersecting_regularities_left_rev_17_03_17.xlsx") %>%
      mutate(stimulus_identity_condition = "Outcome_1_Target_1_Bad_Outcome_2_Target_2_Good"),
    read_xlsx("raw/intersecting_regularities_right_rev_17_03_17.xlsx") %>%
      mutate(stimulus_identity_condition = "Outcome_1_Target_1_Bad_Outcome_2_Target_2_Good")
  ) %>%
  select(subject, stimulus_identity_condition) %>%
  distinct(subject, .keep_all = TRUE)

# stimulus identity using presence of extinction phase files
data_extinction_condition <- 
  bind_rows(
    #_training
    read_xlsx("raw/extinction1a_intersecting_regularities_left_17_03_17.xlsx") %>% 
      mutate(response = as.character(response)),
    read_xlsx("raw/extinction1a_intersecting_regularities_left_rev_17_03_17.xlsx") %>% 
      mutate(response = as.character(response)),
    read_xlsx("raw/extinction1a_intersecting_regularities_right_17_03_17.xlsx") %>% 
      mutate(response = as.character(response)),
    read_xlsx("raw/extinction1a_intersecting_regularities_right_rev_17_03_17.xlsx") %>% 
      mutate(response = as.character(response)),
    #_testing
    read_xlsx("raw/testing_left1a_17_03_17.xlsx") %>% 
      mutate(response = as.character(response)),
    read_xlsx("raw/testing_left1a_rev_17_03_17.xlsx") %>% 
      mutate(response = as.character(response)),
    read_xlsx("raw/testing_right1a_17_03_17.xlsx") %>% 
      mutate(response = as.character(response)),
    read_xlsx("raw/testing_right1a_rev_17_03_17.xlsx") %>% 
      mutate(response = as.character(response))
  ) %>%
  mutate(extinction_condition = "acquisition and extinction") %>%
  select(subject, extinction_condition) %>%
  distinct(subject, .keep_all = TRUE)

data_conditions <- 
  full_join(data_stimulus_identity_condition,
            data_extinction_condition,
            by = "subject") %>%
  mutate(experiment = 1,
         extinction_condition = ifelse(is.na(extinction_condition), "acquisition only", extinction_condition))

rm(data_stimulus_identity_condition, data_extinction_condition)

```

# Training and testing 

## Get data and tidy

```{r}

data_input <- 
  bind_rows(
    # acquisition_training 
    bind_rows(
      read_xlsx("raw/intersecting_regularities_left_17_03_17.xlsx"),
      read_xlsx("raw/intersecting_regularities_right_17_03_17.xlsx"),
      read_xlsx("raw/intersecting_regularities_left_rev_17_03_17.xlsx"),
      read_xlsx("raw/intersecting_regularities_right_rev_17_03_17.xlsx")
    ) %>%
      mutate(phase = "acquisition_training",
             blocknum = blocknum-1,
             response = as.character(response)),
    
    # acquisition test 
    bind_rows(
      read_xlsx("raw/testing_left_17_03_17.xlsx"),
      read_xlsx("raw/testing_left_rev_17_03_17.xlsx"),
      read_xlsx("raw/testing_right_17_03_17.xlsx"),
      read_xlsx("raw/testing_right_rev_17_03_17.xlsx")
    ) %>%
      mutate(phase = "acquisition_testing",
             response = as.character(response)),
    
    # extinction_training
    bind_rows(
      read_xlsx("raw/extinction1a_intersecting_regularities_left_17_03_17.xlsx"),
      read_xlsx("raw/extinction1a_intersecting_regularities_left_rev_17_03_17.xlsx"),
      read_xlsx("raw/extinction1a_intersecting_regularities_right_17_03_17.xlsx"),
      read_xlsx("raw/extinction1a_intersecting_regularities_right_rev_17_03_17.xlsx")
    ) %>%
      mutate(phase = "extinction_training",
             response = as.character(response)),
    
    # extinction test 
    bind_rows(
      read_xlsx("raw/testing_left1a_17_03_17.xlsx"),
      read_xlsx("raw/testing_left1a_rev_17_03_17.xlsx"),
      read_xlsx("raw/testing_right1a_17_03_17.xlsx"),
      read_xlsx("raw/testing_right1a_rev_17_03_17.xlsx")
    ) %>%
      mutate(phase = "extinction_testing",
             response = as.character(response))
  ) %>%
  filter(blockcode != "Begin") %>% 
  select(subject, phase, block_number = blocknum, trial_number = trialnum, correct) %>%
  arrange(subject, phase)

```

## Completeness

```{r}

data_completeness <- data_input %>%
  group_by(subject, phase) %>%
  summarize(n = n()) %>%
  mutate(complete_training_testing_data = 
           case_when((phase == "acquisition_training" & n == 80) |
                       (phase == "acquisition_testing" & n == 8) |
                       (phase == "extinction_training" & n == 80) |
                       (phase == "extinction_testing" & n == 8) ~ "complete", 
                     (phase == "acquisition_training" & n > 80) |
                       (phase == "acquisition_testing" & n > 8) |
                       (phase == "extinction_training" & n > 80) |
                       (phase == "extinction_testing" & n > 8) ~ "excess", 
                     (phase == "acquisition_training" & n < 80) |
                       (phase == "acquisition_testing" & n < 8) |
                       (phase == "extinction_training" & n < 80) |
                       (phase == "extinction_testing" & n < 8) ~ "partial")) %>%
  ungroup()

data_completeness %>%
  count(phase, complete_training_testing_data) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE)

```

## Performance

```{r}

data_performance_temp <- data_input %>%
  # summarize performance by block
  group_by(subject, phase, block_number) %>% 
  summarise(mean_correct = mean(correct), 
            sd_correct = sd(correct)) %>%
  mutate(passed_performance_criterion_by_block = ifelse(mean_correct < .75, FALSE, TRUE)) %>%
  ungroup() %>% 
  # summarize performance by participant (final block only)
  group_by(subject, phase) %>% 
  mutate(passed_performance_criterion = ifelse(block_number == max(block_number) & passed_performance_criterion_by_block == TRUE, TRUE, FALSE)) %>%
  ungroup() %>%
  mutate(phase = fct_relevel(phase,
                             "extinction_testing",
                             "extinction_training",
                             "acqusitiion_testing",
                             "acqusitiion_training")) %>%
  drop_na()

# plot
data_performance_temp %>% 
  group_by(phase, block_number, passed_performance_criterion_by_block) %>% 
  summarise(mean_accuracy = mean(mean_correct), sd_accuracy = sd(sd_correct)) %>%
  ggplot(aes(x=block_number, y=mean_accuracy, fill = passed_performance_criterion_by_block)) +
  geom_bar(colour="black", stat="identity", position = position_dodge()) + 
  geom_errorbar(aes(ymin=mean_accuracy-sd_accuracy, ymax=mean_accuracy+sd_accuracy), width=.2,
                position=position_dodge(.9)) + theme_classic() +
  facet_wrap(~phase, ncol = 1)


data_performance <- data_performance_temp %>%
  group_by(subject, phase) %>% 
  filter(block_number == max(block_number)) %>%
  ungroup() %>%
  select(-block_number, -passed_performance_criterion_by_block, -sd_correct) %>%
  pivot_wider(names_from = phase,
              values_from = c(mean_correct, passed_performance_criterion))

```

- NB because the last block each participant completes is selected, if participants have partial data, their means refer to their last completed block not the ultimate block. therefore ensure that partial data exclusions are done.

# Combine and write to disk

```{r}

data_processed <- data_conditions %>%
  full_join(data_completeness, by = "subject") %>%
  full_join(data_performance, by = "subject") %>%
  select(experiment, subject, 
         extinction_condition, stimulus_identity_condition, 
         complete_training_testing_data, 
         mean_correct_acquisition_training,                
         mean_correct_acquisition_testing,                 
         mean_correct_extinction_testing,                  
         mean_correct_extinction_training,                 
         passed_performance_criterion_acquisition_training,
         passed_performance_criterion_acquisition_testing, 
         passed_performance_criterion_extinction_testing,  
         passed_performance_criterion_extinction_training) 

write_csv(data_processed, "processed/data_processed.csv")

```



